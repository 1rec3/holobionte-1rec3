const { app, BrowserWindow, ipcMain } = require('electron');
const { spawn } = require('child_process');
const path = require('path');
const http = require('http');

let mainWindow;

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1200,
    height: 900,
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
      preload: path.join(__dirname, 'preload.js')
    },
    backgroundColor: '#667eea'
  });

  mainWindow.loadFile('renderer/index.html');
  mainWindow.webContents.openDevTools();
  mainWindow.on('closed', () => { mainWindow = null; });
}

app.whenReady().then(createWindow);
app.on('window-all-closed', () => { if (process.platform !== 'darwin') app.quit(); });
app.on('activate', () => { if (BrowserWindow.getAllWindows().length === 0) createWindow(); });

// FIX: Handler LLM
ipcMain.handle('query-llm', async (event, prompt) => {
  console.log('ðŸ”¥ Query recibido:', prompt);
  
  return new Promise((resolve, reject) => {
    const postData = JSON.stringify({
      model: "deepseek-r1:8b",
      prompt: prompt,
      stream: false
    });

    const options = {
      hostname: 'localhost',
      port: 11434,
      path: '/api/generate',
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(postData)
      },
      timeout: 60000
    };

    console.log('ðŸ“¡ Enviando a Ollama...');

    const req = http.request(options, (res) => {
      let data = '';
      
      res.on('data', (chunk) => { 
        data += chunk; 
        console.log('ðŸ“¥ Chunk recibido:', chunk.length, 'bytes');
      });
      
      res.on('end', () => {
        console.log('âœ… Respuesta completa');
        try {
          const response = JSON.parse(data);
          console.log('âœ… JSON parseado OK');
          resolve(response.response || 'Sin respuesta');
        } catch (e) {
          console.error('âŒ Error parsing JSON:', e);
          resolve('Error: ' + data.substring(0, 200));
        }
      });
    });

    req.on('error', (e) => { 
      console.error('âŒ Error request:', e);
      reject(e); 
    });
    
    req.on('timeout', () => {
      console.error('â±ï¸ Timeout');
      req.destroy();
      reject(new Error('Timeout'));
    });

    req.write(postData);
    req.end();
  });
});

ipcMain.handle('exec-command', async (event, command) => {
  return new Promise((resolve) => {
    const proc = spawn('bash', ['-c', command]);
    let stdout = '', stderr = '';
    proc.stdout.on('data', (data) => { stdout += data.toString(); });
    proc.stderr.on('data', (data) => { stderr += data.toString(); });
    proc.on('close', (code) => { resolve({ stdout, stderr, returncode: code }); });
  });
});

ipcMain.handle('launch-browser', async (event, url) => {
  const browserPath = path.join(process.env.HOME, 'holobionte/apps/BrowserOS.AppImage');
  spawn(browserPath, [`--app=${url}`], { detached: true });
  return `BrowserOS abierto: ${url}`;
});

console.log('ðŸ¤– NuAndi Electron + DeepSeek R1 8B LISTO');
